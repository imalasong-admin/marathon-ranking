# Marathon Ranking Project
马拉松成绩排行榜系统 - 一个用于记录和展示马拉松赛事成绩的在线平台。

# Marathon Ranking Project Status

## 当前版本信息
- 最新稳定版本: [b7857e3]
- 最后更新: 2024-11-24
- 部署地址: https://marathon-ranking.vercel.app

## 最近完成的功能
✅ 移动端适配（2024-11-25）
   - 个人信息编辑页
   - 注册/登录页
   - 成绩提交页

✅ 移动端适配（2024-11-24）
   - 超马越野榜移动端适配
   - 个人中心移动端适配

✅ 移动端适配（2024-11-23）
   - 规划、规范
   - 独立移动端导航条
   - rankings马拉松榜单页面移动端适配
   - age-adjusted-rankings实力榜页面移动适配

✅ 个人中心优化（2024-11-22）
- 重构个人中心页面结构
- 新增独立编辑页面
- 增强权限控制

✅ AuthOptions 导入路径统一化
   状态：待优化
   优先级：低（系统正常运行）
   触发时机：
     - 开发新功能涉及用户认证时
     - 修复认证相关 bug 时
     - 进行版本升级时
   优化方案：
     1. 统一使用 lib/auth.js
     2. 修改所有 API 路由和页面中的导入 
       // TODO: 优化 - 在下次修改此文件时，将 authOptions 的导入统一为 lib/auth.js
       import { authOptions } from '../auth/[...nextauth]'; //注意层级
     3. 涉及文件：
       - pages/api/admin/*
       - pages/api/users/*
       - pages/api/records/*
       - pages/api/races/*
       - pages/admin/*
   注意事项：
    - 修改时需逐个文件测试
    - 确保 getServerSession 的正确导入
    - 根据文件层级调整导入路径
✅ 马拉松榜/实力榜的分页显示（2024-11-21）
✅ 常住地（2024-11-21）
- 美国加拿大的州和8万人以上城市

✅ 实力排行榜功能（2024-11-20）
- 创建马拉松实力排行榜（考虑年龄性别系数）
- 实现年龄性别系数自动计算
- 上线新页面 /age-adjusted-rankings
- 原始成绩和调整后成绩双显示
- 完成的具体工作：
  * 创建 ageFactors 工具函数
  * 修改 Record 模型添加 adjustedSeconds 字段
  * 更新 /api/records API 支持调整后成绩计算
  * 优化排行榜界面展示
  * 添加排行榜切换功能

✅ 成绩验证/举报功能（2024-11-19）
- 记录验证人/举报人

✅ 成绩管理功能（2024-11-18）
- 实现管理员专用的成绩管理功能
- 按记录创建时间倒序显示所有成绩记录
- 展示全面的记录信息（用户、成绩、比赛、验证状态）
- 支持编辑功能（成绩时间、比赛场次、证明链接）
- 支持删除功能（带二次确认）
- 修改记录后自动重置验证状态
- 完成的具体工作：
  * 创建成绩管理页面和相关组件
  * 添加成绩编辑和删除的API路由
  * 实现完整的管理员权限控制
  * 优化数据展示和用户交互

✅ 管理功能优化（2024-11-17）
- 赛事管理和场次管理增加操作人显示
- 区分创建者和最后修改者
- 显示管理员标识
- 完成的具体工作：
  * 修改 Series 和 Race 模型添加 lastModifiedBy 字段
  * 更新相关 API 以记录最后操作人
  * 优化管理界面显示操作人信息
  * 修复场次编辑时赛事更新问题

✅ 数据结构适配和日期处理优化（2024-11-16）
- 修正成绩模块以适配新的赛事-场次结构
- 优化了日期的存储和显示机制
- 统一了全项目的日期处理标准
- 完成的具体工作：
  * 更新了 /api/races 接口的数据返回结构
  * 修改了成绩提交和显示页面的数据获取逻辑
  * 修正了日期显示不一致的问题
  * 建立了标准的日期处理规范
  
✅ 赛事管理功能（2024-11-15）
  - 创建标准赛事库
  - 维护基本赛事信息（名称、类型、地点、官网）
  - 赛事列表展示
  - 赛事添加和编辑
  - 确保赛事数据一致性

✅ 比赛场次管理功能（2024-11-15）
  - 从标准赛事库选择赛事添加场次
  - 场次列表展示
  - 场次编辑功能
  - 场次锁定/解锁功能
  - 完整的错误处理和用户提示

✅ 个人中心优化（2024-11-11）
  - 显示用户生日替代年龄
  - 修改密码改为折叠式显示
  - 优化成绩链接的显示和交互

✅ 成绩验证功能（2024-11-11）
  - 其他用户可验证比赛成绩
  - 显示验证人数和状态
  - 防止重复验证和自验证
  - 完整的数据持久化

✅ 个人中心修改密码功能（2024-11-08）
  - 个人中心添加密码修改模块
  - 修改成功后自动退出登录
  - API：/api/users/[id]/change-password

✅ 忘记密码功能（2024-11-08）
  - 登录页添加忘记密码入口
  - 邮箱验证码验证
  - 密码重置流程
  - 开发环境验证码处理优化

✅ 项目规范强化/开发规范更新（2024-11-08）
  - 明确路由结构规范
  - 添加代码修改原则
  - 总结开发经验教训

     ## 注意事项
       1. 代码修改必须遵循项目的一致性原则
       2. 特别注意动态路由[id]的结构设计
       3. API调用路径需要匹配文件结构
       4. 修改前必须理解现有代码

✅ 邮箱验证功能（2024-11-08）
  - 新用户注册需要验证邮箱
  - 验证码 24 小时有效期
  - 未验证用户显示顶部验证提示
  - 验证成功后需重新登录
  - 旧用户默认已验证

✅ 开发调试优化（2024-11-08）
  - 开发环境邮件统一发送到测试邮箱
  - 开发环境允许重复注册测试

 ✅ 成绩展示和提交优化（2024-11-06）
   - 个人中心比赛成绩列表增加项目列显示
   - 马拉松成绩项目直接显示"26.2英里"
   - 超马成绩显示具体项目类型
   - 修复马拉松成绩提交时的验证问题
   - 优化了数据返回和展示逻辑

 ✅ 数据模型优化（2024-11-05）
   - 简化比赛类型为全程马拉松和超马两类
   - Record模型增加ultraDistance字段
   - 完成数据迁移工作

 ✅ 数据模型优化（2024-11-05）
   - 简化比赛类型为全程马拉松和超马两类
   - Record模型增加ultraDistance字段
   - 完成数据迁移工作

✅ 提交入口优化（2024-11-05）
   - 优化个人中心提交入口
   - 简化超马成绩提交流程
   - 改进提交后的跳转逻辑

✅ 榜单展示优化（2024-11-05）
   - 优化超马榜单展示方式
   - 提升榜单加载性能
   - 改进数据处理逻辑
✅ 页面架构优化（2024-11-05）
   - 新增独立首页
   - 分离 rankings 和首页功能
   - 更新导航栏 logo 为图片

✅ 超马榜单开发（2024-11-05）
   - 创建超马排行榜页面
   - 实现2024年超马成绩展示
   - 添加超马成绩提交入口

✅ 成绩提交流程优化（2024-11-05）
   - 创建分步骤提交界面
   - 实现比赛类型和年份选择
   - 区分不同入口的默认设置
     - ranking页面点击提交成绩默认2024年、全程马拉松
     - ultra-ranking页面点击提交成绩默认2024年、非全程马拉松
     - users页面点击提交成绩选择10个年份、全部比赛类型

✅ 比赛管理功能增强（2024-11-05）
   - 添加比赛类型字段（必填）
   - 增加地点和官网字段（选填）
   - 优化数据结构和验证

✅ 管理员权限系统（2024-11-03）
   - 管理员分级控制（超级管理员/普通管理员）
   - 管理员控制台实现
   - 用户权限管理
   - 用户锁定管理

✅ 管理员功能详细说明
   A. 超级管理员(admin)权限：
   - 设置/取消其他用户的管理员权限
   - 锁定/解锁用户账号
   - 查看所有用户信息
   
   B. 普通管理员权限：
   - 锁定/解锁普通用户
   - 查看用户列表
   
   C. 用户锁定机制：
   - 锁定用户时可设置原因
   - 被锁定用户无法登录
   - 被锁定用户的成绩在排行榜隐藏
   - 解锁后自动恢复所有功能

 ✅ 个人中心功能（2024-11-02）
   - 实现用户个人中心页面
   - 个人成绩列表展示
   - 个人简介编辑功能
   - 用户权限控制

 ✅ 排行榜功能增强（2024-11-01）
   - 实现用户名链接到个人中心
   - 优化比赛日期显示
   - 添加年龄组和性别筛选

 ✅ 比赛管理功能（2024-10-30）
   - 创建 Race 模型
   - 实现比赛添加和选择
   - API 路由实现

 ✅ 成绩记录优化（2024-10-30）
   - 移除冗余字段（性别和年龄）
   - 关联比赛信息
   - 优化数据结构

✅ 用户注册功能（2024-10-25）
   - 添加性别字段
   - 注册后自动登录
   - 自动跳转到成绩提交页面


## 注意事项
1. 管理员权限控制
   - 只有 admin 账号可以管理管理员权限
   - 管理员账号不能被锁定
   - 不能修改 admin 账号的权限
2. 用户锁定影响
   - 对排行榜显示有影响
   - 对用户登录状态有影响
3. 数据安全
   - 需要定期备份用户权限数据
   - 谨慎使用锁定功能
4. 年龄计算逻辑：根据比赛日期计算参赛年龄
5. 环境变量配置需要同步更新到 Vercel
6. 测试数据需要维护合理的日期范围
7. 代码修改后需要重启开发服务器（npm run dev）
8. 用户资料编辑需要进行权限控制
9. 比赛类型数据处理
    - rankings.js 中旧数据默认显示为马拉松类型
    - 此逻辑须保留到数据迁移完成
    - 后续优化需确保所有记录有正确的比赛类型
10. 提交入口差异
    - rankings 页面：限定2024年马拉松
    - ultra-rankings 页面：限定2024年非马拉松
    - 个人中心：自由选择年份和类型

11. Resend 邮件服务
# 免费额度
- 每月100封邮件
- 开发环境统一发送到测试邮箱
- 基本邮件功能支持

# 监控方法
1. 登录 Resend 控制台
2. 查看邮件发送统计
3. 监控发送量接近限制

# 避免超额
1. 开发环境使用测试邮箱
2. 生产环境谨慎使用
3. 设置额度提醒


### 环境配置
```.env.local
MONGODB_URI=mongodb+srv://...
NEXTAUTH_SECRET=...
NEXTAUTH_URL=https://marathon-ranking.vercel.app
RESEND_API_KEY=your_api_key（邮件服务密钥）
```

## 每次新对话开始时复制：
项目：Marathon Ranking
仓库：https://github.com/imalasong-admin/marathon-ranking
部署：https://marathon-ranking.vercel.app
状态：

